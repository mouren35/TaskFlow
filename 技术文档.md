# 📘 技术文档（TSD）

## 1. 技术选型目标

- **快速开发**：最大化利用 Meteor 的全栈优势（实时数据、内置 build、热更新）。
- **减少重复代码**：MVVM 架构 + React hooks/state 管理。
- **跨平台支持**：一次开发，支持 Android / iOS。
- **流畅体验**：使用动画库和性能优化手段，保证交互丝滑。
- **数据简单化**：本地优先，MongoDB 持久化存储，支持离线缓存。

---

## 2. 技术栈

### 2.1 前端

- **框架**：React + TypeScript
- **架构模式**：MVVM

  - **View**：React 组件（UI 层，Material UI + 自定义组件）
  - **ViewModel**：React Hooks（状态逻辑、任务管理、计时器逻辑）
  - **Model**：MongoDB Collections（任务、时间块、习惯、思考节点等数据模型）

- **UI 库**：Material UI（基础组件，风格统一，类似 Google App）
- **动画库**：Motion（页面切换、任务展开收起、FAB 动画等）
- **状态管理**：

  - Meteor 自带 reactive data sources（minimongo）
  - React Context / Zustand（轻量状态管理，替代 Redux，避免过度复杂化）

- **路由**：React Router v6（页面导航：计划 / 安排 / 思考 / 我的）

### 2.2 后端

- **平台**：Meteor（集成 Node.js + DDP + Build system）
- **数据库**：MongoDB（Meteor 内置支持，文档型数据库，适合任务/时间块结构）
- **数据订阅**：Meteor Publish/Subscribe（实时数据同步）
- **任务调度**：Node-cron（处理任务提醒/定时器到期事件）

### 2.3 移动端支持

- **跨平台运行时**：Meteor + Cordova（快速封装，适合 MVP 小应用）
- **未来可扩展**：可替换为 React Native（如需更高性能）

### 2.4 工程化与工具

- **构建工具**：Meteor 内置构建（支持热更新）
- **代码规范**：

  - ESLint + Prettier（代码风格统一）
  - Husky + lint-staged（提交前校验）

- **包管理**：npm / yarn
- **版本管理**：Git（GitHub/GitLab，语义化 commit）
- **单元测试**：Jest + React Testing Library
- **E2E 测试**：Cypress（任务流、计时器流）

### 2.5 动画与体验优化

- **动画**：Motion（FAB 展开、任务折叠、TreeView 动效）
- **性能优化**：

  - React.lazy + Suspense（按需加载）
  - Virtualized List（长列表任务优化，如 react-window）
  - MongoDB 索引优化（任务时间 / 状态字段）

---

## 3. 数据库设计（MongoDB Collections）

### 3.1 时间块（timeBlocks）

```ts
{
  _id: string,
  title: string,
  date: Date,
  startTime: string, // 08:00
  endTime: string,   // 09:30
  repeat: { type: 'daily' | 'weekly' | 'monthly' | 'none', rule: any },
  createdAt: Date,
  updatedAt: Date
}
```

### 3.2 任务（tasks）

```ts
{
  _id: string,
  blockId: string,       // 关联时间块
  title: string,
  category: 'social' | 'mind' | 'health' | 'work' | 'hobby',
  estimatedTime: number, // 预计分钟
  actualTime?: number,
  repeat?: object,
  status: 'pending' | 'inProgress' | 'completed',
  notes?: string,
  createdAt: Date,
  completedAt?: Date
}
```

### 3.3 思考（thoughts）

```ts
{
  _id: string,
  parentId?: string,  // TreeView 父节点
  title: string,
  category: 'social' | 'mind' | 'health' | 'work' | 'hobby',
  estimatedTime: number, // 预计分钟
  actualTime?: number,
  notes?: string,
  status: 'pending' | 'completed',
  createdAt: Date,
  completedAt?: Date
}
```

### 3.4 用户数据（userStats）

```ts
{
  _id: string,
  completedTasks: number,
  totalTime: number,   // 小时
  joinDate: Date
}
```

---

## 4. 系统架构

```
       ┌───────────────────────────┐
       │         View (UI)         │
       │ React + Material UI       │
       └─────────────┬─────────────┘
                     │
       ┌─────────────▼─────────────┐
       │     ViewModel (逻辑层)    │
       │ React Hooks / Zustand     │
       └─────────────┬─────────────┘
                     │
       ┌─────────────▼─────────────┐
       │      Model (数据层)       │
       │ MongoDB Collections       │
       └─────────────┬─────────────┘
                     │
       ┌─────────────▼─────────────┐
       │    Meteor Publish/Sync    │
       │ Cordova runtime (移动端) │
       └───────────────────────────┘
```

---

## 5. 开发规范

1. **代码目录结构**

```
/client   → React 组件 & ViewModel
/server   → Meteor 服务端逻辑 (publish, cron jobs)
/imports  → 公共代码（models, hooks, utils）
/imports/ui       → Material UI 自定义主题 & 样式
/tests    → 单元测试 & E2E
```

2. **命名规范**

- 文件名：kebab-case
- React 组件：PascalCase
- Hooks：useXxx
- Mongo 集合：复数形式（tasks, timeBlocks）

3. **接口规范**

- 所有数据通过 Meteor methods / publications
- 错误统一返回 `{ errorCode, message }`

---

## 6. 非功能需求实现方案

- **流畅动画**：Motion + requestAnimationFrame
- **离线支持**：Meteor 内置 minimongo（本地缓存，网络恢复自动同步）
- **数据安全**：MongoDB 权限控制（仅客户端可访问自己的数据，method 检查用户 ID）
- **扩展性**：未来可无缝迁移到 GraphQL（Apollo）
